// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                          String    @id @default(cuid())
  email                       String    @unique
  password                    String
  firstName                   String
  lastName                    String
  displayName                 String?
  phone                       String?
  avatar                      String?
  userType                    String    @default("pedestrian")
  role                        String    @default("user")
  emailVerified               Boolean   @default(false)
  language                    String    @default("en")
  city                        String?
  state                       String?
  country                     String    @default("India")
  subscriptionPlan            String    @default("free")
  subscriptionStatus          String    @default("active")
  dataProcessingConsent       Boolean   @default(false)
  consentDate                 DateTime?
  consentVersion              String    @default("1.0")
  locationSharingLevel        String    @default("coarse")
  crowdsourcingParticipation  Boolean   @default(true)
  personalizedRecommendations Boolean   @default(true)
  analyticsConsent            Boolean   @default(false)
  marketingConsent            Boolean   @default(false)
  riskTolerance               Int       @default(50)
  timePreference              String    @default("safety_first")
  lastLoginAt                 DateTime?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  loginAttempts               Int       @default(0)
  lockedUntil                 DateTime?
  dataRetentionExpiry         DateTime?

  // Relations
  safetyReports       SafetyReport[]
  routes              Route[]
  emergencyAlerts     EmergencyAlert[]
  incidentReports     IncidentReport[]
  emergencyContacts   EmergencyContact[]
  auditLogs           AuditLog[]
  safetySubscriptions SafetySubscription[]
  safetyNotifications SafetyNotification[]
  userDevices         UserDevice[]
  userConsents        UserConsent[]
  safetyPreferences   SafetyPreference[]
  privacySettings     PrivacySettings?
  reputationScore     ReputationScore?
  consentHistories    ConsentHistory[]
  userSessions        UserSession[]
  dataExports         DataExport[]

  @@index([email])
}

model SafetyReport {
  id                String    @id @default(cuid())
  userId            String
  latitude          Float
  longitude         Float
  address           String?
  landmark          String?
  city              String?
  state             String?
  reportType        String
  reportCategory    String
  severity          Int       @default(3)
  title             String
  description       String
  tags              String?
  images            String?
  video             String?
  status            String    @default("pending")
  verifiedBy        String?
  verificationCount Int       @default(0)
  officialConfirmed Boolean   @default(false)
  timeOfDay         String?
  weatherCondition  String?
  crowdLevel        String?
  lightingLevel     String?
  upvotes           Int       @default(0)
  downvotes         Int       @default(0)
  helpfulCount      Int       @default(0)
  flaggedCount      Int       @default(0)
  actionTaken       String?
  resolvedBy        String?
  resolutionNotes   String?
  resolutionDate    DateTime?
  deviceInfo        String?
  appVersion        String?
  reportMethod      String    @default("app")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Route {
  id               String   @id @default(cuid())
  userId           String
  startLat         Float
  startLng         Float
  endLat           Float
  endLng           Float
  startAddress     String?
  endAddress       String?
  routeData        String
  distance         Float
  duration         Int
  elevationGain    Float?
  safetyScore      Int
  lightingScore    Int?
  hazardCount      Int      @default(0)
  riskSegments     String?
  safetyFactors    String?
  routeType        String
  routeCategory    String   @default("primary")
  userType         String   @default("pedestrian")
  transportMode    String?
  weatherCondition String?
  timeOfDay        String?
  trafficLevel     String?
  crowdLevel       String?
  localEvents      String?
  preferences      String?
  feedback         String?
  rating           Int?
  actualTravelTime Int?
  incidents        String?
  alternatives     String?
  parentRouteId    String?
  isRecommended    Boolean  @default(false)
  dynamicUpdates   String?
  alertsActive     Boolean  @default(false)
  lastUpdated      DateTime @default(now())
  calculationTime  Int?
  algorithmVersion String   @default("1.0")
  dataSourcesUsed  String?
  emergencyExits   String?
  nearbyHelp       String?
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model EmergencyAlert {
  id         String    @id @default(cuid())
  userId     String
  latitude   Float
  longitude  Float
  alertType  String
  message    String?
  status     String    @default("active")
  contacts   String
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  user User @relation(fields: [userId], references: [id])
}

model IncidentReport {
  id                String    @id @default(cuid())
  userId            String?
  latitude          Float
  longitude         Float
  address           String?
  landmark          String?
  incidentType      String
  subcategory       String?
  severity          Int
  urgency           String    @default("medium")
  title             String?
  description       String?
  tags              String?
  images            String?
  audio             String?
  video             String?
  mediaProcessed    Boolean   @default(false)
  status            String    @default("pending")
  verifiedBy        String?
  verificationCount Int       @default(0)
  crossReports      Int       @default(0)
  officialConfirmed Boolean   @default(false)
  trustScore        Float?
  reliabilityScore  Float?
  isAnonymous       Boolean   @default(false)
  reporterTrust     Float?
  reporterHistory   String?
  timeOfIncident    DateTime?
  reportDelay       Int?
  weatherCondition  String?
  crowdLevel        String?
  lightingCondition String?
  trafficLevel      String?
  upvotes           Int       @default(0)
  downvotes         Int       @default(0)
  helpfulVotes      Int       @default(0)
  flaggedCount      Int       @default(0)
  comments          String?
  commentsCount     Int       @default(0)
  affectedUsers     Int       @default(0)
  routesImpacted    String?
  safetyImpact      String    @default("local")
  actionTaken       String?
  resolvedBy        String?
  resolutionNotes   String?
  resolutionDate    DateTime?
  followUpRequired  Boolean   @default(false)
  aiAnalysis        String?
  sentimentScore    Float?
  topicsExtracted   String?
  similarReports    String?
  deviceInfo        String?
  appVersion        String?
  reportMethod      String    @default("app")
  dataQuality       String    @default("medium")
  consentGiven      Boolean   @default(true)
  dataRetention     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User? @relation(fields: [userId], references: [id])
}

model EmergencyContact {
  id                      String    @id @default(cuid())
  userId                  String
  name                    String
  phone                   String
  email                   String?
  relationship            String
  priority                Int       @default(1)
  isActive                Boolean   @default(true)
  verificationCode        String? // For storing the verification code
  verificationCodeExpires DateTime? // For storing the expiration time of the verification code
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  metadata  String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model POIData {
  id                 String   @id @default(cuid())
  name               String
  category           String
  subcategory        String?
  latitude           Float
  longitude          Float
  address            String?
  phone              String?
  website            String?
  hours              String?
  isEmergencyService Boolean  @default(false)
  isActive           Boolean  @default(true)
  rating             Float?
  reviewCount        Int      @default(0)
  lastUpdated        DateTime @default(now())
  dataSource         String
  municipalityId     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([category])
  @@index([latitude, longitude])
}

model SafetyDataSource {
  id              String   @id @default(cuid())
  name            String
  type            String
  reliability     Int
  updateFrequency Int
  lastUpdated     DateTime @default(now())
  isActive        Boolean  @default(true)
  apiEndpoint     String?
  apiKey          String?
  dataFormat      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([isActive])
}

model SafetyEvent {
  id          String    @id @default(cuid())
  sourceId    String
  eventType   String
  severity    String
  latitude    Float
  longitude   Float
  radius      Int?
  startTime   DateTime
  endTime     DateTime?
  description String
  metadata    Json?
  isVerified  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([eventType])
  @@index([severity])
  @@index([latitude, longitude])
  @@index([startTime])
}

model SafetySubscription {
  id                   String   @id @default(cuid())
  userId               String
  deviceId             String
  latitude             Float?
  longitude            Float?
  radius               Int?
  eventTypes           String[]
  minSeverity          String?
  notificationChannels String[]
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([deviceId])
  @@index([isActive])
}

model SafetyNotification {
  id        String   @id @default(cuid())
  userId    String
  deviceId  String
  eventId   String
  title     String
  message   String
  severity  String
  timestamp DateTime @default(now())
  isRead    Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([deviceId])
  @@index([isRead])
  @@index([timestamp])
}

model UserDevice {
  id         String   @id @default(cuid())
  userId     String
  deviceId   String   @unique
  deviceType String?
  pushToken  String?
  isActive   Boolean  @default(true)
  lastSeen   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([deviceId])
  @@index([isActive])
}

model UserConsent {
  id          String   @id @default(cuid())
  userId      String
  consentType String
  status      String   @default("pending")
  timestamp   DateTime @default(now())
  details     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([consentType])
  @@index([status])
  @@index([timestamp])
}

model SafetyScore {
  id             String    @id @default(cuid())
  latitude       Float
  longitude      Float
  geohash        String?
  overallScore   Int
  confidence     Float?
  lightingScore  Int?
  footfallScore  Int?
  hazardScore    Int?
  proximityScore Int?
  timeOfDay      String?
  userType       String?
  sources        String?
  factors        String?
  lightingData   String?
  footfallData   String?
  hazardData     String?
  timestamp      DateTime  @default(now())
  lastUpdated    DateTime  @default(now())
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([latitude, longitude])
  @@index([timestamp])
  @@index([userType, timeOfDay])
}

model SafetyPreference {
  id                                 String   @id @default(cuid())
  userId                             String
  riskTolerance                      Int      @default(50)
  timePreference                     String   @default("safety_first")
  preferredFactors                   String?
  locationSharingLevel               String   @default("coarse")
  personalizedRecommendations        Boolean  @default(true)
  analyticsConsent                   Boolean  @default(false)
  crowdsourcingParticipation         Boolean  @default(true)
  autoReportIncidents                Boolean  @default(false)
  shareLocationWithEmergencyContacts Boolean  @default(false)
  createdAt                          DateTime @default(now())
  updatedAt                          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PrivacySettings {
  id                          String   @id @default(cuid())
  userId                      String   @unique
  dataProcessingConsent       Boolean  @default(false)
  locationSharingLevel        String   @default("coarse")
  crowdsourcingParticipation  Boolean  @default(true)
  personalizedRecommendations Boolean  @default(true)
  analyticsConsent            Boolean  @default(false)
  marketingConsent            Boolean  @default(false)
  consentVersion              String   @default("1.0")
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model ReputationScore {
  id                String   @id @default(cuid())
  userId            String   @unique
  trustLevel        Float    @default(0.5)
  communityStanding String   @default("new")
  reputationPoints  Int      @default(0)
  lastUpdated       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([trustLevel])
}

model ConsentHistory {
  id             String   @id @default(cuid())
  userId         String
  consentType    String
  consentVersion String
  granted        Boolean
  grantedAt      DateTime @default(now())
  ipAddress      String?
  userAgent      String?
  details        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([consentType])
  @@index([grantedAt])
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  refreshToken String   @unique
  deviceId     String?
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  expiresAt    DateTime
  lastUsedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([sessionToken])
  @@index([refreshToken])
  @@index([isActive])
  @@index([expiresAt])
}

model DataExport {
  id          String    @id @default(cuid())
  userId      String
  requestType String
  status      String    @default("pending")
  dataTypes   String?
  requestedAt DateTime  @default(now())
  expiresAt   DateTime
  completedAt DateTime?
  downloadUrl String?
  fileSize    Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
}
